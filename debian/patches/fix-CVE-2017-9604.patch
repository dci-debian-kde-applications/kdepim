From 78c5552be2f00a4ac25bd77ca39386522fca70a8 Mon Sep 17 00:00:00 2001
From: Montel Laurent <montel@kde.org>
Date: Fri, 2 Jun 2017 13:59:02 +0200
Subject: Make sure that we use plugin when we use sendlater feature

---
 kmail/editor/kmcomposerwin.cpp | 9 +++++----
 kmail/editor/kmcomposerwin.h   | 3 ++-
 2 files changed, 7 insertions(+), 5 deletions(-)

--- a/kmail/editor/kmcomposerwin.cpp
+++ b/kmail/editor/kmcomposerwin.cpp
@@ -2376,7 +2376,7 @@ void KMComposerWin::printComposeResult(K
 }
 
 void KMComposerWin::doSend(MessageComposer::MessageSender::SendMethod method,
-                           MessageComposer::MessageSender::SaveIn saveIn)
+                           MessageComposer::MessageSender::SaveIn saveIn, bool willSendItWithoutReediting)
 {
     if (mStorageService->numProgressUpdateFile() > 0) {
         KMessageBox::sorry(this, i18np("There is %1 file upload in progress.",
@@ -2391,7 +2391,7 @@ void KMComposerWin::doSend(MessageCompos
         }
     }
 
-    if (saveIn == MessageComposer::MessageSender::SaveInNone) {   // don't save as draft or template, send immediately
+    if (saveIn == MessageComposer::MessageSender::SaveInNone || willSendItWithoutReediting) {   // don't save as draft or template, send immediately
         if (KEmailAddress::firstEmailAddress(from()).isEmpty()) {
             if (!(mShowHeaders & HDR_FROM)) {
                 mShowHeaders |= HDR_FROM;
@@ -2558,6 +2558,7 @@ void KMComposerWin::slotSendLater()
     if (!checkRecipientNumber()) {
         return;
     }
+    mComposerBase->setSendLaterInfo(nullptr);
     if (mComposerBase->editor()->checkExternalEditorFinished()) {
         const bool wasRegistered = (SendLater::SendLaterUtil::sentLaterAgentWasRegistered() && SendLater::SendLaterUtil::sentLaterAgentEnabled());
         if (wasRegistered) {
@@ -2580,9 +2581,9 @@ void KMComposerWin::slotSendLater()
                 case SendLater::SendLaterDialog::SendDeliveryAtTime: {
                     mComposerBase->setSendLaterInfo(info);
                     if (info->isRecurrence()) {
-                        doSend(MessageComposer::MessageSender::SendLater, MessageComposer::MessageSender::SaveInTemplates);
+                        doSend(MessageComposer::MessageSender::SendLater, MessageComposer::MessageSender::SaveInTemplates, true);
                     } else {
-                        doSend(MessageComposer::MessageSender::SendLater, MessageComposer::MessageSender::SaveInDrafts);
+                        doSend(MessageComposer::MessageSender::SendLater, MessageComposer::MessageSender::SaveInDrafts, true);
                     }
                     break;
                 }
--- a/kmail/editor/kmcomposerwin.h
+++ b/kmail/editor/kmcomposerwin.h
@@ -510,7 +510,8 @@ private:
      * Send the message.
      */
     void doSend(MessageComposer::MessageSender::SendMethod method = MessageComposer::MessageSender::SendDefault,
-                MessageComposer::MessageSender::SaveIn saveIn = MessageComposer::MessageSender::SaveInNone);
+                MessageComposer::MessageSender::SaveIn saveIn = MessageComposer::MessageSender::SaveInNone,
+                bool willSendItWithoutReediting = false);
 
     void doDelayedSend(MessageComposer::MessageSender::SendMethod method, MessageComposer::MessageSender::SaveIn saveIn);
 
