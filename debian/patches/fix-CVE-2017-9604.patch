From 78c5552be2f00a4ac25bd77ca39386522fca70a8 Mon Sep 17 00:00:00 2001
From: Montel Laurent <montel@kde.org>
Date: Fri, 2 Jun 2017 13:59:02 +0200
Subject: Make sure that we use plugin when we use sendlater feature

---
 kmail/editor/kmcomposewin.cpp | 9 +++++----
 kmail/editor/kmcomposewin.h   | 3 ++-
 2 files changed, 7 insertions(+), 5 deletions(-)

--- a/kmail/editor/kmcomposewin.cpp
+++ b/kmail/editor/kmcomposewin.cpp
@@ -2671,7 +2671,7 @@ void KMComposeWin::printComposeResult( K
 
 //----------------------------------------------------------------------------
 void KMComposeWin::doSend( MessageComposer::MessageSender::SendMethod method,
-                           MessageComposer::MessageSender::SaveIn saveIn )
+                           MessageComposer::MessageSender::SaveIn saveIn, bool willSendItWithoutReediting)
 {
     if ( mStorageService->numProgressUpdateFile() > 0) {
         KMessageBox::sorry( this, i18np( "There is %1 file upload in progress.",
@@ -2687,7 +2687,7 @@ void KMComposeWin::doSend( MessageCompos
     }
 
 
-    if ( saveIn == MessageComposer::MessageSender::SaveInNone ) { // don't save as draft or template, send immediately
+    if ( saveIn == MessageComposer::MessageSender::SaveInNone || willSendItWithoutReediting) { // don't save as draft or template, send immediately
         if ( KPIMUtils::firstEmailAddress( from() ).isEmpty() ) {
             if ( !( mShowHeaders & HDR_FROM ) ) {
                 mShowHeaders |= HDR_FROM;
@@ -2854,6 +2854,7 @@ void KMComposeWin::slotSendLater()
         return;
     if ( !checkRecipientNumber() )
         return;
+    mComposerBase->setSendLaterInfo(0);
     if ( mComposerBase->editor()->checkExternalEditorFinished() ) {
         const bool wasRegistered = (SendLater::SendLaterUtil::sentLaterAgentWasRegistered() && SendLater::SendLaterUtil::sentLaterAgentEnabled());
         if (wasRegistered) {
@@ -2877,9 +2878,9 @@ void KMComposeWin::slotSendLater()
                 {
                     mComposerBase->setSendLaterInfo(info);
                     if (info->isRecurrence()) {
-                        doSend( MessageComposer::MessageSender::SendLater, MessageComposer::MessageSender::SaveInTemplates );
+                        doSend( MessageComposer::MessageSender::SendLater, MessageComposer::MessageSender::SaveInTemplates, true);
                     } else {
-                        doSend( MessageComposer::MessageSender::SendLater, MessageComposer::MessageSender::SaveInDrafts );
+                        doSend( MessageComposer::MessageSender::SendLater, MessageComposer::MessageSender::SaveInDrafts, true);
                     }
                     break;
                 }
--- a/kmail/editor/kmcomposewin.h
+++ b/kmail/editor/kmcomposewin.h
@@ -575,7 +575,8 @@ private:
      * Send the message.
      */
     void doSend( MessageComposer::MessageSender::SendMethod method=MessageComposer::MessageSender::SendDefault,
-                 MessageComposer::MessageSender::SaveIn saveIn = MessageComposer::MessageSender::SaveInNone );
+                 MessageComposer::MessageSender::SaveIn saveIn = MessageComposer::MessageSender::SaveInNone,
+                 bool willSendItWithoutReediting = false);
 
     void doDelayedSend( MessageComposer::MessageSender::SendMethod method, MessageComposer::MessageSender::SaveIn saveIn );
 
