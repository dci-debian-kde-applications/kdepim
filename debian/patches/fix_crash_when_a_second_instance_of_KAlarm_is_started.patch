From d8c5a241747675e767f96da9444c5745430fab62 Mon Sep 17 00:00:00 2001
From: David Jarvie <djarvie@kde.org>
Date: Sun, 30 Oct 2016 18:05:25 +0000
Subject: Bug 371628: Fix crash when a second instance of KAlarm is started

KDBusService doesn't supply any command line arguments in its
activateRequested() signal unless there is at least one command
line option (in addition to the program name) in the command
invocation.

Forward port of Applications/16.08 commit
6bd68f98d675e30fab24713e63dfe72cdfd6f4f5.
---
 kalarm/kalarmapp.cpp | 12 ++++++++++--
 kalarm/kalarmapp.h   |  1 +
 2 files changed, 13 insertions(+), 3 deletions(-)

--- a/kalarm/kalarmapp.cpp
+++ b/kalarm/kalarmapp.cpp
@@ -122,7 +122,7 @@ KAlarmApp::KAlarmApp(int& argc, char** a
 #endif
 
     // Make this a unique application.
-    KDBusService* s = new KDBusService(KDBusService::Unique);
+    KDBusService* s = new KDBusService(KDBusService::Unique, this);
     connect(this, &KAlarmApp::aboutToQuit, s, &KDBusService::deleteLater);
     connect(s, &KDBusService::activateRequested, this, &KAlarmApp::activate);
 
@@ -332,11 +332,19 @@ void KAlarmApp::activate(const QStringLi
         return;
     }
 
+    // The D-Bus call to activate a subsequent instance of KAlarm may not supply
+    // any arguments, but we need one.
+    if (!args.isEmpty()  &&  mActivateArg0.isEmpty())
+        mActivateArg0 = args[0];
+    QStringList fixedArgs(args);
+    if (args.isEmpty()  &&  !mActivateArg0.isEmpty())
+        fixedArgs << mActivateArg0;
+
     // Parse and interpret command line arguments.
     QCommandLineParser parser;
     KAboutData::applicationData().setupCommandLine(&parser);
     parser.setApplicationDescription(QApplication::applicationDisplayName());
-    const QStringList newArgs = CommandOptions::setOptions(&parser, args);
+    const QStringList newArgs = CommandOptions::setOptions(&parser, fixedArgs);
     parser.process(newArgs);
     KAboutData::applicationData().processCommandLine(&parser);
 
--- a/kalarm/kalarmapp.h
+++ b/kalarm/kalarmapp.h
@@ -196,6 +196,7 @@ class KAlarmApp : public QApplication
         bool               mQuitting;            // a forced quit is in progress
         bool               mReadOnly;            // only read-only access to calendars is needed
         bool               mLoginAlarmsDone;     // alarms repeated at login have been processed
+        QString            mActivateArg0;        // activate()'s first arg the first time it was called
         DBusHandler*       mDBusHandler;         // the parent of the main DCOP receiver object
         TrayWindow*        mTrayWindow;          // active system tray icon
         QTimer*            mAlarmTimer;          // activates KAlarm when next alarm is due
